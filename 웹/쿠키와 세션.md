## 쿠키와 세션

### 쿠키와 세션을 사용하게 된 배경 
> 쿠키와 세션을 이해하기 위해서는 먼저 HTTP의 특징을 이해하면 된다.

- HTTP(Hypertext Transfer Protocol)는 인터넷 상에서 데이터를 주고 받기 위해 서버/클라이언트 모델을 다르는 통신 규약을 말한다.
- 이 HTTP 프로토콜에는 `비연결성(connectionless)`과 `비상태성(stateless)`이라는 특징이 있다.
- 이는 서버의 자원을 절약하기 위해 모든 사용자의 요청마다 연결과 해제의 과정을 거치기 때문에 연결 상태가 유지되지 않고, 연결 해제 후에 상태 정보가 저장되지 않는다는 것이다.
- 그러나, 오히려 이런 점 때문에 사용자를 식별할 수 없어서 같은 사용자가 요청을 여러 번 하더라도 매번 새로운 사용자로 인식하는 단점이 있다. (페이지 이동할 때마다 다시 로그인해야 하고, 웹 페이지의 로딩도 느리게 만드는 요인이 됨)

> 이러한 HTTP의 특징이자 약점인 `비연결성`과 `비상태성`을 보완하여 서버가 클라이언트를 식별하게 해주는 것이 `쿠키`와 `세션`이다.

<br>

### 쿠키란?
- 쿠키는 웹 사이트에 접속할 때 생성되는 정보를 담은 임시 파일이다.
- 쿠키는 서버가 사용자의 웹 브라우저에 저장하는 데이터를 말한다. (엄밀히 말하면 사용자의 로컬 PC에 저장)
- HTTP에서 클라이언트의 상태 정보를 클라이언트의 PC에 저장하였다가 필요 시 정보를 참조하거나 재사용할 수 있다.

<br>

### 쿠키의 특징
- 쿠키의 데이터 형태는 key-value 쌍으로 구성되고 String 형태로 이루어져 있다.
- 브라우저마다 저장되는 쿠키는 다르다.(크롬으로 남긴 쿠키 IE에서 사용 X)
- 서버에서는 브라우저가 다르면 다른 사용자로 인식한다.

<br>

### 쿠키의 구성요소
- Name: 쿠키의 이름
- Value: 쿠키의 저장된 값
- Expires: 쿠키가 언제 삭제되는지 결정
    - ex) `exprires="Wdy, DD-Mon-YYYY HH:MM:SS GMT"`
    - 위의 예시처럼 쿠키에 만료일이 포함되어 있으면 `영구적 쿠키`로 간주
    - Max-Age를 통해 지정된 만료일이 되면 디스크에서 쿠키 제거
- Domain: 쿠키가 사용되는 도메인을 지정
    - ex) `domain=www.naver.com`
    - 이 값이 현재 탐색 중인 도메인과 일치하지 않을 경우, `타사 쿠키`로 간주되어 브라우저에서 거부
    - 한 도메인에서 다른 도메인에 대한 쿠키를 사용하지 못하게 설정
- Path: 쿠키를 반환할 경로를 결정
    - ex) `path=/`
    - 위 예시의 경우 도메인의 루트 경로로 이동할 경우 쿠키가 전송
    - 도메인의 뒤에 붙은 경로라고 생각하면 된다. (`www.naver.com` + `/`)
    - path를 입력하지 않으면 현재 도메인의 경로로 자동 입력
    - 지정한 경로의 하위에서만 해당 쿠키에 접근 가능
- Secure: 보안 연결 설정
- HttpOnly: Http 외에 다른 통신 사용 가능 설정

<br>

### 쿠키의 종류
#### 세션 쿠키(session cookie)
- 사용자가 사이트를 탐색할 때, 관련한 설정과 선호 사항들을 저장하는 임시 쿠키이다.
- 세션 쿠키는 디스크에 저장되지 않기 때문에 사용자가 브라우저를 닫으면 삭제된다.

#### 지속 쿠키(persistent cookie)
- 삭제되지 않고 더 길게 유지될 수 있다.
- 지속 쿠키는 디스크에 저장되기 때문에 브라우저를 닫거나 컴퓨터를 재시작하더라도 남아 있다.
- 지속 쿠키는 사용자가 주기적으로 방문하는 사이트에 대한 설정 정보나 로그인 이름을 유지하려고 사용한다.

#### Secure cookie
- 암호화된 연결 HTTPS로만 전송할 수 있다.
- Secure 플래그를 추가해서 생성하며, HTTPS로 전송하기 때문에 쿠키를 열어보는 것을 방지할 수 있다.

#### third-party cookie
- 현재 방문하고 있는 사이트가 아닌 다른 사이트의 쿠키
- 광고와 같은 외부 웹사이트의 컨텐츠가 있을 때 생성되며 이 쿠키를 이용하여 사용자를 추적하고, 광고를 제공하는 데에 사용한다.

<br>

### 쿠키의 동작 순서
<img src="https://i.imgur.com/vIEUmpa.png" width="700px" />

<br>

1. 클라이언트가 서버로 페이지를 요청(request)한다.
2. 서버에서는 쿠키를 생성하고, 생성한 쿠키에 정보를 담아 요청에 대한 응답과 함께 HTTP 헤더에 쿠키를 포함시켜 클라이언트에게 돌려준다.
3. 클라이언트가 넘겨 받은 쿠키는 클라이언트의 웹 브라우저(로컬PC)에 저장하고 있다가 다시 서버에 페이지를 요청할 일이 생기면 요청의 HTTP 헤더에 쿠키를 담아 전송한다.
4. 서버는 전송 받은 쿠키와 서버에 저장된 사용자 정보를 비교하여 같은 사용자임을 확인하고 알맞은 응답을 클라이언트에게 돌려준다.
    - 서버에서 쿠키를 읽어 이전 상태 정보를 변경할 필요가 있을 경우, 쿠키를 업데이트하여 변경된 쿠키를 HTTP 헤더에 포함시켜 응답

<br>

### 쿠키 사용 예시
- ID 저장, 로그인 상태 유지
- 팝업창의 일주일간 다시 보지 않기 체크
- 최근 검색한 상품들을 광고에서 추천
- 쇼핑몰 장바구니 기능

<br>

### 쿠키의 단점
- 쿠키에는 방문했던 웹 사이트에 대한 정보 및 개인정보가 기록되기 때문에 사생활이 침해될 수 있다. 이것을 방지하기 위해 웹 브라우저 자체에 쿠키 거부 기능이 있다. 그러나 웹 브라우저에 쿠키 거부가 설정되어 있으면, 쿠키 본래의 목적인 웹 브라우저와의 연결을 지속시키는 기능을 수행할 수 없게 된다.
- 서버가 가지고 있는 것이 아니라 클라이언트의 로컬PC에 저장되기 때문에, 임의로 고치거나 지울 수 있고 가로채기도 쉬워서 보안에 취약하다. 따라서, 쿠키에는 민감하거나 중요한 정보를 담는 것은 위험하다.
- 쿠키에 대한 정보를 매번 HTTP 헤더에 추가하여 보내기 때문에 상당한 트래픽을 발생시킨다.
> 이런 단점을 보완해주는 것이 `세션`이다.

<br>

### 세션이란?
- 일정 시간동안 같은 클라이언트(브라우저)로부터 들어오는 일련의 요구를 하나의 상태로 보고, 그 상태를 일정하게 유지시키는 기술이다.
- 여기서 일정 시간은 방문자가 웹 브라우저를 통해 웹 서버에 접속한 시점으로부터 웹 브라우저를 종료하여 연결을 끝내는 시점을 말한다.
- 방문자가 웹 서버에 접속해있는 상태를 하나의 단위로 보고 그것을 `세션`이라고 한다.

<br>

### 세션의 특징
- 세션은 쿠키를 기반으로 하고 있지만, 쿠키와 다르게 사용자 정보 파일을 서버 측에서 관리한다.
- 서버에서는 클라이언트를 구분하기 위해 각 클라이언트 고유의 세션 ID를 부여하며 웹 브라우저가 서버에 접속해서 브라우저를 종료할 때까지 인증상태를 유지한다.
- 접속 시간에 제한을 두어 일정 시간 응답이 없다면 세션을 끊도록 설정할수도 있다.
- 클라이언트 정보 자체가 서버에 저장되어 있기 때문에 쿠키에 비해 비교적 안전하다.
- 사용자가 많아질수록 서버 메모리를 많이 차지하게 된다.
- 따라서 동접자 수가 많은 웹 사이트인 경우 서버에 과부하를 주게 되므로 성능 저하의 요인이 된다.
- 서버가 허용하는 한 용량 제한이 없다.

<br>

### 세션의 동작 순서
<img src="https://i.imgur.com/6mY9vIf.png" width="700px" />

<br>

1. 클라이언트가 페이지를 요청한다.
2. 서버는 클라이언트가 보낸 HTTP request의 `Request-Header` 필드인 쿠키를 확인하고, 클라이언트가 `session id`를 보냈는지 확인한다.
3. `session id`가 존재하지 않는다면, 서버는 `Set-Cookie`를 통해 `session id`를 생성해 클라이언트에게 돌려준다.
5. 클라이언트는 이후 서버에 요청할 때 전달받았던 쿠키를 요청 헤더에 추가하여 요청을 보낸다.
6. 서버에서는 클라이언트가 보낸 요청헤더의 `session id` 값을 저장된 세션저장소에서 찾아보고 유효한지 확인하고 요청을 처리한 후 응답한다.


<br>

### 세션 사용 예시
- 페이지를 이동해도 로그인이 풀리지 않고 로그아웃하기 전까지 유지

<br>

### 쿠키/세션 방식의 단점
- 해커가 A사용자의 HTTP 요청을 가로채게 되면 그 안에 있는 쿠키를 훔칠 수 있다. 그리고 훔친 쿠키를 이용해 서버에 HTTP 요청을 보내면 서버의 세션저장소에서는 해커를 A사용자라고 오인하여 정보를 잘못 반환할 수 있다. => `세션 하이재킹 공격`
- 해결책
    - HTTPS를 사용해 요청 자체를 탈취하더라도 안의 정보를 읽기 힘들게 만든다.
    - 세션에 유효시간을 넣어준다.

<br>

### cookie와 session 비교 요약
|  | cookie | session |
| -------- | -------- | -------- |
| 저장위치     | Client     | Server     |
|저장형식	|Text	|Object|
|만료시점	|쿠키 저장시 설정(설정 없으면 브라우저 종료 시)|	정확한 시점 모름|
|리소스	|클라이언트의 리소스	|서버의 리소스
용량제한	|한 도메인 당 20개, 한 쿠키당 4KB|	제한없음

<br>

### 저장 위치
쿠키 : 클라이언트의 웹 브라우저가 지정하는 메모리 or 하드디스크

세션 : 서버의 메모리에 저장

<br>

### 만료 시점
쿠키 : 저장할 때 expires 속성을 정의해 무효화시키면 삭제될 날짜 정할 수 있음

세션 : 클라이언트가 로그아웃하거나, 설정 시간동안 반응이 없으면 무효화 되기 때문에 정확한 시점 알 수 없음

<br>

### 리소스
쿠키 : 클라이언트에 저장되고 클라이언트의 메모리를 사용하기 때문에 서버 자원 사용하지 않음

세션 : 세션은 서버에 저장되고, 서버 메모리로 로딩 되기 때문에 세션이 생길 때마다 리소스를 차지함

<br>

### 용량 제한
쿠키 : 클라이언트도 모르게 접속되는 사이트에 의하여 설정될 수 있기 때문에 쿠키로 인해 문제가 발생하는 걸 막고자 한 도메인당 20개, 하나의 쿠키 당 4KB로 제한해 둠

세션 : 클라이언트가 접속하면 서버에 의해 생성되므로 서버가 허용하는 한 개수나 용량 제한 없음


<br>
<br>


### 추가적으로 공부해도 좋을 것
[세션 공유 문제](https://thecodinglog.github.io/web/2020/08/11/what-is-session.html)
<br>

### reference
https://hahahoho5915.tistory.com/32   쿠키와 세션
https://feel5ny.github.io/2019/11/16/HTTP_011_02/   쿠키
https://nesoy.github.io/articles/2017-03/Session-Cookie  쿠키와 세션
https://devuna.tistory.com/23  쿠키와 세션
https://gyoogle.dev/blog/web-knowledge/Cookie%20&%20Session.html   쿠키와 세션 비교